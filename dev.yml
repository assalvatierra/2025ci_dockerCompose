services:
  kong:
    image: kong:latest
    container_name: api-gateway
    volumes:
      - ./kong.yml:/usr/local/kong/declarative/kong.yml
    environment:
      - KONG_DATABASE=off
      - KONG_DECLARATIVE_CONFIG=/usr/local/kong/declarative/kong.yml
      - KONG_PROXY_ACCESS_LOG=/dev/stdout
      - KONG_ADMIN_ACCESS_LOG=/dev/stdout
      - KONG_PROXY_ERROR_LOG=/dev/stderr
      - KONG_ADMIN_ERROR_LOG=/dev/stderr
      - KONG_ADMIN_LISTEN=0.0.0.0:8001, 0.0.0.0:8444 ssl
    ports:
      - "8000:8000"
      - "8443:8443"
      - "127.0.0.1:8001:8001"
      - "127.0.0.1:8444:8444"

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672" # Standard AMQP port
      - "15672:15672" # Management UI port
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest

  redis:
    image: redis:latest
    container_name: redis
    ports:
      - "6379:6379"      

  postgres:
    image: postgres:16
    container_name: postgres
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: 123456
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  mongodb:
    image: mongo:latest
    container_name: mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: 123456
    volumes:
      - mongodata:/data/db

  elasticsearch:
    # image: docker.elastic.co/elasticsearch/elasticsearch:8.9.0
    image: elasticsearch:9.2.3
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - xpack.security.enabled=false
      - xpack.monitoring.collection.enabled=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
    mem_limit: 1g
    ports:
      - "9200:9200"
      - "9300:9300"

  kibana:
    image: kibana:9.2.3
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
    depends_on:
      - elasticsearch

  # apiserver:
  #   # image: ghcr.io/assalvatierra/2025ci_apiserver/myapp:latest
  #   image: local-myapp:latest
  #   container_name: myApiServer
  #   ports:
  #     - "8080:8080"
  #     - "8081:8081"
  #   environment:
  #     # Add environment variables as needed, e.g.:
  #     ASPNETCORE_ENVIRONMENT: Development
  #     ASPNETCORE_URLS: http://0.0.0.0:8080
  #     ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=postgres;Username=admin;Password=123456"
  #   depends_on:
  #      - postgres

  # clientapp:
  #   # image: ghcr.io/assalvatierra/2025ci_ngclient:latest
  #   image: local-ngclient:latest
  #   container_name: myClientApp
  #   ports:
  #     - "50361:80"
  #   environment:
  #     - API_URL_docker=http://localhost:8080
  #     - API_URL=https://localhost:7083
  #     - APP_NAME=Angular Client (Docker Compose)
  #     - PRODUCTION=false
  #   depends_on:
  #     - apiserver

volumes:
  pgdata:
  mongodata: